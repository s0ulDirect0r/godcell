# Worklog - November 19, 2025

## Morning Session: Stage 1 Refinement - Movement and Threat Tuning

**Branch:** `stage-1-refinement`
**PR #13:** "Stage 1 refinement: momentum system, AI improvements, and countdown timer" - Open

**Closed Issues:**
- godcell-zh7: Allow distortions to spawn near/on map edges
- godcell-ahb: Update AI to avoid distortion cores
- godcell-m2v: Add energy countdown timer (digital watch style)
- godcell-cdr: Double movement speed for all characters
- godcell-uzs: Add momentum/inertia to player movement

---

### Momentum/Inertia System

**Problem:** Movement felt too stiff and instant-stop on key release. No sense of floating in the digital ocean. New faster speeds (doubled) made gravity wells trivial.

**Implementation:**

1. **Velocity Persistence with Friction:**
   - Changed from instant velocity zeroing to exponential decay: `v = v * friction^dt`
   - Friction coefficient: 0.85 (velocity decays smoothly over time)
   - Applied to both players and swarms for consistency
   - Frame-rate independent using deltaTime

2. **Acceleration-Based Controls:**
   - Player input now adds acceleration instead of setting velocity directly
   - Acceleration = `PLAYER_SPEED * 8` for responsive feel
   - Velocity caps at `PLAYER_SPEED * 1.2` (20% overspeed for gravity boost)
   - Creates "coast" effect when releasing keys while maintaining control

3. **Swarm Movement Overhaul:**
   - Fixed bug: swarms were adding velocity directly without deltaTime (60x per second!)
   - Converted to acceleration-based: `SWARM_SPEED * 8 * deltaTime`
   - Applied same friction/momentum system as players
   - Obstacle avoidance also uses acceleration with deltaTime

4. **Gravity Integration:**
   - Gravity forces accumulate into existing velocity (no reset)
   - Applied as acceleration: `force * deltaTime`
   - Swarms have 80% gravity resistance (20% of normal force)

**Final Tuned Values:**
- Players: 336 px/s (started at 400, reduced 30%, then +20%)
- Swarms: 242 px/s (maintains speed differential)
- Gravity: 0.72 strength (12x original 0.06 to compensate for momentum)
- Friction: 0.85 decay per second

**Result:** Floaty, space-like movement that feels amazing. Gravity wells are properly threatening again.

---

### AI Obstacle and Swarm Avoidance

**Problem:** Bots were getting crushed by singularity cores frequently, ignoring dangers completely.

**Implementation:**

1. **Obstacle Avoidance Function:**
   - Graduated threat zones:
     - Core radius (60px): Maximum panic (1.0 avoidance strength)
     - Event horizon (180px): Strong avoidance (0.7-1.0 scaled)
     - Caution radius (270px): Gentle avoidance (0.3-0.7 scaled)
   - Returns avoidance force vector away from nearest threats
   - Combined with goal-seeking behavior (nutrients/wander)

2. **Swarm Avoidance Function:**
   - Separate avoidance for entropy swarms
   - Threat zones:
     - Contact radius (47px): Taking damage, maximum panic
     - Threat radius (350px): Half detection range, high avoidance
     - Caution radius (700px): Full detection range, gentle avoidance
   - Allows bots to navigate around both static and moving threats

3. **Behavior Integration:**
   - Both avoidance forces combined with movement goal
   - Final direction normalized to prevent super-speed
   - Applied using deltaTime for frame-rate independence

**Result:** Bots now intelligently path around dangers while still pursuing nutrients. Significantly fewer singularity deaths.

---

### Eva-Style Energy Countdown Timer

**Problem:** Energy depletion wasn't visceral enough. Needed constant tension reminder.

**Implementation:**

1. **Visual Design:**
   - Position: Center-top of viewport (fixed)
   - Format: `SS:TT` (seconds:hundredths) - Evangelion battery style
   - Font: 32px bold monospace
   - Updates at 60fps for smooth countdown feel

2. **Color Transitions:**
   - >30s: Cyan (#00ffff) - Safe zone
   - 15-30s: Yellow (#ffff00) - Warning
   - <15s: Red (#ff0000) - Critical with pulsing scale effect

3. **Technical Details:**
   - Client-side calculation: `energy / ENERGY_DECAY_RATE = seconds`
   - Updates every frame in `update()` loop
   - Independent of throttled server energy broadcasts (10fps)
   - Pulse effect uses sine wave: `1 + sin(time/200) * 0.1`

**Result:** Creates relentless tension. That ticking countdown to starvation is constantly in your face.

---

### Swarm Threat Enhancements

**Problem:** Swarms weren't threatening enough at new speeds. Players could easily outrun them.

**Implementation:**

1. **Population Doubled:**
   - Count: 9 → 18 swarms
   - Better map coverage, harder to avoid

2. **Size Increase:**
   - Radius: 39 → 47 pixels (20% larger)
   - Bigger collision zone, easier to catch players

3. **Movement Slow Debuff:**
   - New mechanic: contact with swarm slows player by 40%
   - Applied to both acceleration and max velocity cap
   - Creates "caught in web" feeling
   - Makes escape difficult once touched
   - Multiplier: 0.6 (60% normal speed when touched)

**Result:** Swarms are now genuinely dangerous. Getting caught is often fatal.

---

### Edge Spawning for Obstacles

**Problem:** Obstacles spawning only in interior created safe edge-camping zones.

**Implementation:**
- Spawn padding: 700px → 150px
- Obstacles can now spawn very close to map edges
- Creates boundary pressure and interesting dynamics
- No more safe zones to camp

---

## Session Statistics

**Files Modified:** 6 (shared, server/index, server/bots, server/swarms, client/GameScene, beads)

**Commits:**
1. Add momentum/inertia system with tuned speeds and gravity
2. Add AI avoidance for obstacles and swarms
3. Add Eva-style energy countdown timer at center-top
4. Close stage-1-refinement beads

**Lines Changed:** ~400+ insertions/deletions

**Testing Notes:**
- Movement feel tested extensively through iterative tuning
- Gravity strength tripled during testing to compensate for momentum
- Speeds adjusted multiple times (400 → 280 → 336 for players)
- Swarm slow debuff doubled from initial 20% to final 40%
- All changes tested with bots and swarms to ensure AI still functions

---

## Key Learnings

1. **Iterative Tuning is Essential:**
   - Started with 2x speed, ended at 1.68x after multiple adjustments
   - Gravity needed 12x increase to feel right with momentum
   - Can't predict perfect values - must test and iterate

2. **Frame-Rate Independence Matters:**
   - Swarms had critical bug (adding velocity 60x per second)
   - All physics must use deltaTime for consistency
   - Exponential decay formula crucial: `pow(friction, deltaTime)`

3. **Feedback Loops:**
   - Momentum system affects gravity feel
   - Gravity strength affects escape difficulty
   - Speed affects threat level
   - All systems interconnected, tune holistically

4. **Client vs Server Updates:**
   - Countdown timer needed 60fps client-side updates
   - Server broadcasts at 10fps weren't smooth enough
   - Separate client-side calculation from server state

---

## Next Steps

- Merge PR #13 after review/testing
- Continue stage 1 difficulty tuning if needed
- Consider movement energy cost (godcell-5zn) next
- Visual improvements (trails, timer, sprites)
