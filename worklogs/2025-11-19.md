# Worklog - November 19, 2025

## Morning Session: Stage 1 Refinement - Movement and Threat Tuning

**Branch:** `stage-1-refinement`
**PR #13:** "Stage 1 refinement: momentum system, AI improvements, and countdown timer" - Open

**Closed Issues:**

- godcell-zh7: Allow distortions to spawn near/on map edges
- godcell-ahb: Update AI to avoid distortion cores
- godcell-m2v: Add energy countdown timer (digital watch style)
- godcell-cdr: Double movement speed for all characters
- godcell-uzs: Add momentum/inertia to player movement

---

### Momentum/Inertia System

**Problem:** Movement felt too stiff and instant-stop on key release. No sense of floating in the digital ocean. New faster speeds (doubled) made gravity wells trivial.

**Implementation:**

1. **Velocity Persistence with Friction:**
   - Changed from instant velocity zeroing to exponential decay: `v = v * friction^dt`
   - Friction coefficient: 0.85 (velocity decays smoothly over time)
   - Applied to both players and swarms for consistency
   - Frame-rate independent using deltaTime

2. **Acceleration-Based Controls:**
   - Player input now adds acceleration instead of setting velocity directly
   - Acceleration = `PLAYER_SPEED * 8` for responsive feel
   - Velocity caps at `PLAYER_SPEED * 1.2` (20% overspeed for gravity boost)
   - Creates "coast" effect when releasing keys while maintaining control

3. **Swarm Movement Overhaul:**
   - Fixed bug: swarms were adding velocity directly without deltaTime (60x per second!)
   - Converted to acceleration-based: `SWARM_SPEED * 8 * deltaTime`
   - Applied same friction/momentum system as players
   - Obstacle avoidance also uses acceleration with deltaTime

4. **Gravity Integration:**
   - Gravity forces accumulate into existing velocity (no reset)
   - Applied as acceleration: `force * deltaTime`
   - Swarms have 80% gravity resistance (20% of normal force)

**Final Tuned Values:**

- Players: 336 px/s (started at 400, reduced 30%, then +20%)
- Swarms: 242 px/s (maintains speed differential)
- Gravity: 0.72 strength (12x original 0.06 to compensate for momentum)
- Friction: 0.85 decay per second

**Result:** Floaty, space-like movement that feels amazing. Gravity wells are properly threatening again.

---

### AI Obstacle and Swarm Avoidance

**Problem:** Bots were getting crushed by singularity cores frequently, ignoring dangers completely.

**Implementation:**

1. **Obstacle Avoidance Function:**
   - Graduated threat zones:
     - Core radius (60px): Maximum panic (1.0 avoidance strength)
     - Event horizon (180px): Strong avoidance (0.7-1.0 scaled)
     - Caution radius (270px): Gentle avoidance (0.3-0.7 scaled)
   - Returns avoidance force vector away from nearest threats
   - Combined with goal-seeking behavior (nutrients/wander)

2. **Swarm Avoidance Function:**
   - Separate avoidance for entropy swarms
   - Threat zones:
     - Contact radius (47px): Taking damage, maximum panic
     - Threat radius (350px): Half detection range, high avoidance
     - Caution radius (700px): Full detection range, gentle avoidance
   - Allows bots to navigate around both static and moving threats

3. **Behavior Integration:**
   - Both avoidance forces combined with movement goal
   - Final direction normalized to prevent super-speed
   - Applied using deltaTime for frame-rate independence

**Result:** Bots now intelligently path around dangers while still pursuing nutrients. Significantly fewer singularity deaths.

---

### Eva-Style Energy Countdown Timer

**Problem:** Energy depletion wasn't visceral enough. Needed constant tension reminder.

**Implementation:**

1. **Visual Design:**
   - Position: Center-top of viewport (fixed)
   - Format: `SS:TT` (seconds:hundredths) - Evangelion battery style
   - Font: 32px bold monospace
   - Updates at 60fps for smooth countdown feel

2. **Color Transitions:**
   - > 30s: Cyan (#00ffff) - Safe zone
   - 15-30s: Yellow (#ffff00) - Warning
   - <15s: Red (#ff0000) - Critical with pulsing scale effect

3. **Technical Details:**
   - Client-side calculation: `energy / ENERGY_DECAY_RATE = seconds`
   - Updates every frame in `update()` loop
   - Independent of throttled server energy broadcasts (10fps)
   - Pulse effect uses sine wave: `1 + sin(time/200) * 0.1`

**Result:** Creates relentless tension. That ticking countdown to starvation is constantly in your face.

---

### Swarm Threat Enhancements

**Problem:** Swarms weren't threatening enough at new speeds. Players could easily outrun them.

**Implementation:**

1. **Population Doubled:**
   - Count: 9 → 18 swarms
   - Better map coverage, harder to avoid

2. **Size Increase:**
   - Radius: 39 → 47 pixels (20% larger)
   - Bigger collision zone, easier to catch players

3. **Movement Slow Debuff:**
   - New mechanic: contact with swarm slows player by 40%
   - Applied to both acceleration and max velocity cap
   - Creates "caught in web" feeling
   - Makes escape difficult once touched
   - Multiplier: 0.6 (60% normal speed when touched)

**Result:** Swarms are now genuinely dangerous. Getting caught is often fatal.

---

### Edge Spawning for Obstacles

**Problem:** Obstacles spawning only in interior created safe edge-camping zones.

**Implementation:**

- Spawn padding: 700px → 150px
- Obstacles can now spawn very close to map edges
- Creates boundary pressure and interesting dynamics
- No more safe zones to camp

---

## Session Statistics

**Files Modified:** 6 (shared, server/index, server/bots, server/swarms, client/GameScene, beads)

**Commits:**

1. Add momentum/inertia system with tuned speeds and gravity
2. Add AI avoidance for obstacles and swarms
3. Add Eva-style energy countdown timer at center-top
4. Close stage-1-refinement beads

**Lines Changed:** ~400+ insertions/deletions

**Testing Notes:**

- Movement feel tested extensively through iterative tuning
- Gravity strength tripled during testing to compensate for momentum
- Speeds adjusted multiple times (400 → 280 → 336 for players)
- Swarm slow debuff doubled from initial 20% to final 40%
- All changes tested with bots and swarms to ensure AI still functions

---

## Key Learnings

1. **Iterative Tuning is Essential:**
   - Started with 2x speed, ended at 1.68x after multiple adjustments
   - Gravity needed 12x increase to feel right with momentum
   - Can't predict perfect values - must test and iterate

2. **Frame-Rate Independence Matters:**
   - Swarms had critical bug (adding velocity 60x per second)
   - All physics must use deltaTime for consistency
   - Exponential decay formula crucial: `pow(friction, deltaTime)`

3. **Feedback Loops:**
   - Momentum system affects gravity feel
   - Gravity strength affects escape difficulty
   - Speed affects threat level
   - All systems interconnected, tune holistically

4. **Client vs Server Updates:**
   - Countdown timer needed 60fps client-side updates
   - Server broadcasts at 10fps weren't smooth enough
   - Separate client-side calculation from server state

---

## Next Steps

- Merge PR #13 after review/testing
- Continue stage 1 difficulty tuning if needed
- Consider movement energy cost (godcell-5zn) next
- Visual improvements (trails, timer, sprites)

---

## Afternoon Session: Stage 2 Multi-Cell Evolution Mechanics

**Branch:** `stage-2-mechanics`
**PR #15:** "Stage 2: Multi-cell evolution mechanics" - Open

**Closed Issues:**

- godcell-bve: Multi-cell evolution (size + metabolic efficiency)
- godcell-piv: Expanded detection radius (chemical sensing)
- godcell-r5e: Expanded viewport for multi-cells

**Created Issues:**

- godcell-r5e: Expanded viewport for multi-cells (created and immediately implemented)

---

### Stage-Specific Visual Evolution

**Problem:** All players looked identical (single circles) regardless of evolution stage. No visual feedback for progression.

**Implementation:**

1. **Stage-Aware Sprite System:**
   - Created `buildStageVisuals()` helper function
   - Returns different sprite configurations per stage
   - Uses container-based architecture to preserve references

2. **Sprite Designs:**
   - **Stage 1 (Single-Cell):** Simple circle (24px radius)
   - **Stage 2+ (Multi-Cell):** Star cluster - 6 circles in tight formation
     - 5 outer circles (background layer)
     - 1 center circle (foreground layer, creates overlapping effect)
     - Star radius: 8px for tight overlap
   - Container child management allows sprite swapping during evolution

3. **Evolution Animation:**
   - Kill existing pulse tween before transformation
   - Remove old sprites, add new stage-specific sprites
   - Animate scale growth with Back.easeOut (500ms)
   - Restart pulse animation at new scale
   - Flash effect for visual impact

**Result:** Visual progression is now clear. Multi-cells look distinctly different from single-cells.

---

### Stage-Specific Metabolic Efficiency

**Problem:** All stages had same energy decay rate. No gameplay benefit to evolving beyond capacity increase.

**Implementation:**

1. **Energy Decay Rates (units per second):**
   - **Single-Cell:** 2.66/s (~37.5s survival time)
   - **Multi-Cell:** 2.1/s (~119s ≈ 2 minutes)
   - **Cyber-Organism:** 2.8/s (~178s ≈ 3 minutes)
   - **Humanoid:** 3.3/s (~303s ≈ 5 minutes)
   - **Godcell:** 0/s (transcended thermodynamics)

2. **Server-Side Integration:**
   - Created `getEnergyDecayRate(stage)` helper
   - Metabolism system uses stage-specific rates
   - Higher stages = better efficiency (longer survival)

3. **Timer UI Update:**
   - Timer was using hardcoded decay rate
   - Added stage tracking to `myPlayerStats`
   - Created `getStageDecayRate()` client helper
   - Godcells display `∞∞:∞∞` (infinite survival)

**Result:** Evolution now provides meaningful survival advantage. Multi-cells can plan, hunt, and explore without constant starvation pressure.

---

### Chemical Sensing Detection System

**Problem:** Multi-cells had no predatory advantage. Couldn't hunt effectively without extended senses.

**Implementation:**

1. **Server-Side Detection:**
   - Detection radius: 1800px (reduced from initial 2400px to prevent clutter)
   - Broadcasts every 15 ticks (~4 updates/sec)
   - Only sends to Stage 2+ players
   - Detects players and nutrients within range
   - Private detection data (each predator sees their own)

2. **Client-Side Visualization:**
   - Edge-of-screen arrow indicators
   - Arrows point toward detected entities
   - **Proximity-based scaling:** closer = bigger arrows, farther = smaller arrows
   - Scale formula: `0.5 + (1.0 - normalizedDistance) * 1.5` (0.5x to 2.0x)
   - Color coding: Magenta for players, Green for nutrients
   - No distance text (visual clutter)

3. **Network Messages:**
   - Created `DetectedEntity` interface (id, position, type, stage)
   - Created `DetectionUpdateMessage` type
   - Added to `ServerMessage` union

**Result:** Multi-cells now "sense" prey chemically. Big arrows for close threats, small arrows for distant ones. Intuitive visual feedback.

---

### Expanded Viewport (Camera Zoom)

**Problem:** Multi-cells had chemical sensing but same viewport as single-cells. Couldn't leverage their expanded awareness.

**Implementation:**

1. **Stage-Based Zoom Levels:**
   - Created `getStageZoom(stage)` helper
   - **Stage 1:** 1.0x (base zoom)
   - **Stage 2:** 0.67x zoom (1.5x more visible area)
   - **Stage 3:** 0.5x zoom (2x more area)
   - **Stage 4:** 0.4x zoom (2.5x more area)
   - **Stage 5:** 0.33x zoom (3x more area)

2. **Camera Integration:**
   - Initial zoom set on gameState load
   - Smooth tween on evolution (1000ms Sine.easeInOut)
   - Reset to 1.0x on respawn
   - Works in parallel with size/sprite evolution animations

**User Feedback:** "Lol that was so wild, I got so huge. It zoomed out every evolution which was cool."

**Result:** Higher stages feel progressively more powerful and aware. Natural progression: evolve → see more → understand more.

---

### Scaled Hitbox System

**Problem:** Visual size increased but collision radius stayed at 24px. Multi-cells couldn't collect nutrients easily despite being visually huge.

**Implementation:**

1. **Player Radius Helper:**
   - Created `getPlayerRadius(stage)` helper function
   - Returns `PLAYER_SIZE * SIZE_MULTIPLIER` per stage
   - Stage 1: 24px (1x), Stage 2: 96px (4x), etc.

2. **Collision Updates:**
   - Nutrient collection: Uses `getPlayerRadius()` instead of hardcoded `PLAYER_SIZE`
   - World bounds clamping: Accounts for scaled radius
   - Collision radius: `playerRadius + NUTRIENT_SIZE`

**User Feedback:** "We need to make sure the hitbox also grows however it got hard to pick up nutrients."

**Result:** Hitbox now matches visual size. Multi-cells can easily vacuum up nutrients.

---

### Size Multipliers

**Final Tuned Values:**

- **Single-Cell:** 1x (24px radius)
- **Multi-Cell:** 4x (96px radius) - initially 3x, increased per user feedback
- **Cyber-Organism:** 6x (144px radius)
- **Humanoid:** 8x (192px radius)
- **Godcell:** 12x (288px radius)

---

## Session Statistics

**Files Modified:** 4 (shared, server/index, client/GameScene, beads)

**Commits:**

1. Add stage-specific energy decay rates and size multipliers
2. Use stage-specific energy decay in metabolism system
3. Implement stage-specific sprite visuals and evolution transformation
4. Update beads: mark godcell-bve as in_progress
5. Change multi-cell size multiplier to 4x
6. Add chemical sensing detection with proximity-based arrows (1800px radius)
7. Close godcell-piv and godcell-r5e (detection + viewport complete)

**Lines Changed:** ~460+ insertions, ~35 deletions

**Testing Notes:**

- Detection radius adjusted from 2400px → 1000px → 1800px based on visual clutter
- Arrow scaling tested for intuitive proximity feedback
- Size multiplier tuned from 3x → 4x for better feel
- Camera zoom tested across all 5 evolution stages
- Hitbox scaling verified with nutrient collection

---

## Key Learnings

1. **Iterative UI Refinement:**
   - Started with pixel distance text on arrows (too cluttered)
   - Switched to proximity-based arrow sizing (much cleaner)
   - Visual feedback > numeric precision for real-time gameplay

2. **Container Architecture Benefits:**
   - Using Phaser containers allowed sprite swapping during evolution
   - Preserved camera tracking and trail references
   - Killing tweens before transformation prevents conflicts

3. **Biological Accuracy Drives Design:**
   - Phagocytosis model inspired pseudopod mechanics
   - Chemical sensing (not vision) explains detection arrows
   - Metabolic efficiency improves with complexity (real cell biology)

4. **Hitbox Scaling is Critical:**
   - Visual size must match collision size
   - Otherwise creates frustrating disconnect between appearance and mechanics
   - Applies to all scaling (nutrients, obstacles, world bounds)

5. **Progressive Zoom Creates Progression Feel:**
   - Camera zoom is a powerful progression mechanic
   - Seeing more world = feeling more powerful
   - Works synergistically with detection system

---

## Design Decisions Made

1. **Detection Range:** 1800px (balance between awareness and clutter)
2. **Arrow Scaling:** Proximity-based (0.5x to 2.0x) for intuitive feedback
3. **Size Multiplier:** 4x for multi-cell (user preference over 3x)
4. **Sprite Design:** Star cluster pattern (tight overlapping circles)
5. **Metabolic Rates:** Slower decay at higher stages (biological accuracy)

---

## Next Steps

**Remaining Stage 2 Beads:**

- godcell-6wj: Pseudopod extension mechanic (predation) - Priority 1
- godcell-ola: NPC single-cell prey population - Priority 2
- godcell-l6w: Multi-cells can prey on Stage 1 players (needs design decision) - Priority 2

**Future Considerations:**

- Predator-prey dynamics (NPC hunting grounds)
- PvP predation design decision (should multi-cells hunt real players?)
- Pseudopod combat mechanics
- Plane transcendence (entering the "Cellular Ocean")
